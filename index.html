<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡§≠‡§æ‡§µ‡•á‡§∂‡•ç‡§µ‡§∞‡•Ä ‡§¶‡•Ç‡§ß ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ, ‡§ó‡•ã‡§∞‡§Ç‡§¨‡•á</title>

  <!-- Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- jsPDF / autoTable / SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --primary:#0d6efd;
      --muted:#f4f6fb;
      --card:#ffffff;
      --can-border:#bfbfbf;
      --milk-color:#f6f0dd; /* milk-like pale */
      --milk-fill:#f1c40f; /* yellowish to show fill (you can change to whiteish) */
    }
    body{
      font-family:'Poppins',sans-serif;
      max-width:1000px;
      margin:12px auto;
      padding:14px;
      color:#222;
    }
    h2{text-align:center;margin:0 0 12px 0;}
    nav{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:12px;}
    nav a{
      padding:8px 12px;background:var(--muted);border-radius:6px;color:#111;text-decoration:none;font-weight:500;
    }
    nav a:hover{background:var(--primary);color:#fff}

    section{display:none;}
    section.active{display:block;margin-top:8px;}

    .card{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.06);}

    form{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;}
    form .full{grid-column:1/-1}
    label{font-size:0.9rem;margin-bottom:4px;display:block}
    input,select,button{padding:8px;border:1px solid #ddd;border-radius:6px;font-size:0.95rem}
    button{background:var(--primary);color:#fff;border:none}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #e1e1e1;padding:6px;text-align:center;font-size:0.9rem}
    th{background:#f7f7f7}

    /* Today summary + cans */
    .today-box{display:flex;flex-wrap:wrap;align-items:center;gap:16px;margin:10px 0;padding:12px;border-radius:8px;background:#fbfbfd}
    .today-text{flex:1}
    .cans-row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
    .can{
      width:56px;height:100px;border:3px solid var(--can-border);border-radius:6px 6px 8px 8px;position:relative;
      background:linear-gradient(180deg,#fff,#f9f9f9);overflow:hidden;display:flex;align-items:flex-end;
    }
    .can .milk-fill{
      width:100%;background:linear-gradient(180deg,var(--milk-fill),#f39c12);height:0%;
      transition:height 500ms ease;
      display:flex;align-items:flex-end;justify-content:center;color:#000;font-size:12px;font-weight:600;padding-bottom:4px;
    }
    .can .cap{
      position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:36px;height:10px;background:#ddd;border-radius:4px;
      box-shadow:0 1px 0 rgba(0,0,0,0.05);
    }
    .can-label{text-align:center;font-size:12px;margin-top:6px}

    /* responsive */
    @media(max-width:720px){
      form{grid-template-columns:repeat(1,1fr)}
      .can{width:48px;height:88px}
    }
  </style>
</head>
<body>
  <h2>üêÑ ‡§≠‡§æ‡§µ‡•á‡§∂‡•ç‡§µ‡§∞‡•Ä ‡§¶‡•Ç‡§ß ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ, ‡§ó‡•ã‡§∞‡§Ç‡§¨‡•á</h2>

  <nav>
    <a href="#" onclick="show('home')">üè† ‡§π‡•ã‡§Æ</a>
    <a href="#" onclick="show('collection')">ü•õ ‡§∏‡§Ç‡§ï‡§≤‡§®</a>
    <a href="#" onclick="show('suppliers')">üìã ‡§™‡•Å‡§∞‡§µ‡§†‡§æ‡§¶‡§æ‡§∞</a>
    <a href="#" onclick="show('reports')">üìë ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏</a>
  </nav>

  <!-- HOME -->
  <section id="home" class="active">
    <div class="card">
      <h3 style="margin-top:0">‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä</h3>
      <p>‡§≠‡§æ‡§µ‡•á‡§∂‡•ç‡§µ‡§∞‡•Ä ‡§¶‡•Ç‡§ß ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ, ‡§ó‡•ã‡§∞‡§Ç‡§¨‡•á</p>
      <p>‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï: <strong>9876543210</strong></p>
      <p>‡§Ü‡§Æ‡•ç‡§π‡•Ä ‡§§‡§æ‡§ú‡§Ç ‡§¶‡•Ç‡§ß ‡§∞‡•ã‡§ú ‡§∏‡§Ç‡§ï‡§≤‡§ø‡§§ ‡§ï‡§∞‡§§‡•ã ‡§µ ‡§∏‡•ç‡§•‡§æ‡§®‡§ø‡§ï ‡§Æ‡§æ‡§∞‡•ç‡§ï‡•á‡§ü‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§µ‡§ø‡§§‡§∞‡§ø‡§§ ‡§ï‡§∞‡§§‡•ã.</p>
    </div>
  </section>

  <!-- COLLECTION -->
  <section id="collection">
    <div class="card">
      <h3 style="margin-top:0">‡§¶‡•Ç‡§ß ‡§∏‡§Ç‡§ï‡§≤‡§® ‡§®‡•ã‡§Ç‡§¶</h3>

      <!-- today summary + cans -->
      <div class="today-box">
        <div class="today-text">
          <div style="font-size:0.95rem;color:#555">‡§Ü‡§ú ‡§è‡§ï‡•Ç‡§£ ‡§ú‡§Æ‡§æ ‡§ù‡§æ‡§≤‡•á</div>
          <div style="font-size:1.6rem;font-weight:600"><span id="todayTotal">0</span> ‡§≤‡§ø‡§ü‡§∞</div>
          <div style="font-size:0.85rem;color:#666">(‡§™‡•ç‡§∞‡§§‡§ø ‡§ï‡•Ö‡§® = <span id="perCanLabel">50</span> ‡§≤‡§ø‡§ü‡§∞)</div>
        </div>

        <div>
          <div class="cans-row" id="cansRow">
            <!-- dynamic cans will be injected here -->
          </div>
        </div>
      </div>

      <!-- form -->
      <form onsubmit="event.preventDefault();saveCollection();" class="card" style="margin-top:10px;">
        <div>
          <label>‡§Æ‡•á‡§Ç‡§¨‡§∞ ‡§®‡§Ç‡§¨‡§∞</label>
          <input id="memberNo" type="number" oninput="autoFillName()" placeholder="‡§â‡§¶‡§æ. 101" required>
        </div>
        <div>
          <label>‡§®‡§æ‡§µ</label>
          <input id="memberName" readonly placeholder="‡§ë‡§ü‡•ã-‡§´‡§ø‡§≤">
        </div>

        <div>
          <label>‡§§‡§æ‡§∞‡•Ä‡§ñ</label>
          <input id="c_date" type="date" required>
        </div>
        <div>
          <label>‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</label>
          <select id="c_type" required>
            <option value="">‡§®‡§ø‡§µ‡§°‡§æ</option>
            <option value="‡§ó‡§æ‡§Ø">‡§ó‡§æ‡§Ø</option>
            <option value="‡§Æ‡•ç‡§π‡•à‡§∏">‡§Æ‡•ç‡§π‡•à‡§∏</option>
          </select>
        </div>

        <div>
          <label>‡§≤‡§ø‡§ü‡§∞</label>
          <input id="c_liter" type="number" step="0.1" required>
        </div>
        <div>
          <label>‡§´‡•Ö‡§ü (%)</label>
          <input id="c_fat" type="number" step="0.1" required>
        </div>

        <div>
          <label>‡§∞‡•á‡§ü (‚Çπ/‡§≤‡§ø‡§ü‡§∞)</label>
          <input id="c_rate" type="number" step="0.1" required>
        </div>
        <div>
          <label>‡§∞‡§ï‡•ç‡§ï‡§Æ (‡§ë‡§ü‡•ã)</label>
          <input id="c_amount" type="number" step="0.01" readonly placeholder="‡§ë‡§ü‡•ã ‡§ó‡§£‡§®‡§æ">
        </div>

        <div class="full" style="display:flex;gap:8px">
          <button type="button" style="flex:1" onclick="calcAmount()">‡§∞‡§ï‡•ç‡§ï‡§Æ ‡§ó‡§£‡§®‡§æ</button>
          <button type="submit" style="flex:1">‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ</button>
        </div>
      </form>

      <!-- collection table -->
      <div style="margin-top:12px;overflow:auto">
        <table id="collectionTable">
          <thead>
            <tr><th>‡§Æ‡•á‡§Ç‡§¨‡§∞</th><th>‡§®‡§æ‡§µ</th><th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th><th>‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</th><th>‡§≤‡§ø‡§ü‡§∞</th><th>‡§´‡•Ö‡§ü</th><th>‡§∞‡•á‡§ü</th><th>‡§∞‡§ï‡•ç‡§ï‡§Æ</th></tr>
          </thead>
          <tbody id="collectionBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- SUPPLIERS -->
  <section id="suppliers">
    <div class="card">
      <h3 style="margin-top:0">‡§™‡•Å‡§∞‡§µ‡§†‡§æ‡§¶‡§æ‡§∞ ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä</h3>
      <form onsubmit="event.preventDefault();saveSupplier();">
        <div>
          <label>‡§®‡§æ‡§µ</label><input id="s_name" required>
        </div>
        <div>
          <label>‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤</label><input id="s_mobile" required>
        </div>
        <div>
          <label>‡§ó‡§æ‡§µ</label><input id="s_village" required>
        </div>
        <div style="margin-top:8px"><button type="submit">‡§∏‡•á‡§µ‡•ç‡§π</button></div>
      </form>

      <div style="margin-top:12px;overflow:auto">
        <table>
          <thead><tr><th>‡§®‡§æ‡§µ</th><th>‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤</th><th>‡§ó‡§æ‡§µ</th></tr></thead>
          <tbody id="suppliersBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- REPORTS -->
  <section id="reports">
    <div class="card">
      <h3 style="margin-top:0">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button onclick="downloadPDF()">‡§¶‡•Ç‡§ß ‡§∏‡§Ç‡§ï‡§≤‡§® PDF</button>
        <button onclick="downloadExcel()">‡§¶‡•Ç‡§ß ‡§∏‡§Ç‡§ï‡§≤‡§® Excel</button>
      </div>
    </div>
  </section>

  <!-- non-module script: UI nav -->
  <script>
    function show(id){
      document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      window.scrollTo({top:0,behavior:'smooth'});
    }
    // set today's date default
    (function(){
      const d=new Date(); const iso=d.toISOString().slice(0,10);
      const el=document.getElementById('c_date');
      if(el) el.value = iso;
    })();
  </script>

  <!-- module script: firebase and app logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // ====== Firebase config: replace with your actual config ======
    const firebaseConfig = {
      apiKey: "AIzaSyD_4wQmuzFPJjid-Co9Y-6vgEb70jxWTSY",
      authDomain: "dairy-mill-production.firebaseapp.com",
      databaseURL: "https://dairy-mill-production-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dairy-mill-production",
      storageBucket: "dairy-mill-production.firebasestorage.app",
      messagingSenderId: "721651192386",
      appId: "1:721651192386:web:b5613cedce06deed1e13db",
      measurementId: "G-YQ2BDHS8HG"
    };
    // ==============================================================

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // demo member list (101-110)
    const memberList = {
      101:"‡§∏‡§Ç‡§§‡•ã‡§∑ ‡§™‡§æ‡§ü‡•Ä‡§≤",
      102:"‡§∞‡§æ‡§ú‡•á‡§∂ ‡§ú‡§æ‡§ß‡§µ",
      103:"‡§∏‡•Å‡§®‡§ø‡§§‡§æ ‡§ï‡§æ‡§≥‡•á",
      104:"‡§Ö‡§ú‡§Ø ‡§∂‡§ø‡§Ç‡§¶‡•á",
      105:"‡§Ø‡•ã‡§ó‡•á‡§∂ ‡§ï‡§¶‡§Æ",
      106:"‡§∏‡•ç‡§Æ‡§ø‡§§‡§æ ‡§∏‡§æ‡§µ‡§Ç‡§§",
      107:"‡§ó‡§£‡•á‡§∂ ‡§¶‡•á‡§∂‡§Æ‡•Å‡§ñ",
      108:"‡§™‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§™‡§µ‡§æ‡§∞",
      109:"‡§Æ‡§æ‡§ß‡§µ ‡§Æ‡§æ‡§≥‡•Ä",
      110:"‡§∏‡§™‡§®‡§æ ‡§Æ‡•ã‡§∞‡•á"
    };

    // per-can liters (changeable)
    const perCan = 50;
    document.getElementById('perCanLabel').innerText = perCan;

    // make functions available to inline handlers
    window.autoFillName = function(){
      const no = document.getElementById('memberNo').value;
      document.getElementById('memberName').value = memberList[no] || "";
    }

    window.calcAmount = function(){
      const liters = parseFloat(document.getElementById('c_liter').value || 0);
      const rate = parseFloat(document.getElementById('c_rate').value || 0);
      const amount = (liters * rate).toFixed(2);
      document.getElementById('c_amount').value = isFinite(amount) ? amount : '';
    }

    // save collection
    window.saveCollection = function(){
      const no = document.getElementById('memberNo').value.trim();
      const name = document.getElementById('memberName').value.trim();
      const date = document.getElementById('c_date').value;
      const type = document.getElementById('c_type').value;
      const liters = parseFloat(document.getElementById('c_liter').value || 0);
      const fat = document.getElementById('c_fat').value;
      const rate = document.getElementById('c_rate').value;
      const amount = parseFloat(document.getElementById('c_amount').value || (liters * (rate||0))).toFixed(2);

      if(!no || !name){
        alert('‡§Æ‡•á‡§Ç‡§¨‡§∞ ‡§®‡§Ç‡§¨‡§∞ ‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§®‡§æ‡§π‡•Ä ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§®‡§æ‡§µ ‡§®‡§∏‡§≤‡•á‡§≤‡•á ‡§Æ‡•á‡§Ç‡§¨‡§∞ ‡§Ü‡§π‡•á. 101‚Äì110 ‡§µ‡§æ‡§™‡§∞‡§æ ‡§ï‡§ø‡§Ç‡§µ‡§æ suppliers ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§®‡§µ‡•Ä‡§® ‡§®‡•ã‡§Ç‡§¶ ‡§ï‡§∞‡§æ.');
        return;
      }
      if(!date || !type || !liters){
        alert('‡§∏‡§∞‡•ç‡§µ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§´‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡§æ.');
        return;
      }

      push(ref(db,'milkCollection'),{memberNo:no,name,date,type,liters,fat,rate,amount})
        .then(()=> {
          alert('‡§¶‡•Ç‡§ß ‡§®‡•ã‡§Ç‡§¶ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡•Ä ‚úÖ');
          document.querySelector('form').reset();
          document.getElementById('memberName').value = '';
          // reset date to today
          document.getElementById('c_date').value = new Date().toISOString().slice(0,10);
        })
        .catch(err => { console.error(err); alert('‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä'); });
    }

    // save supplier
    window.saveSupplier = function(){
      const name = document.getElementById('s_name').value.trim();
      const mobile = document.getElementById('s_mobile').value.trim();
      const village = document.getElementById('s_village').value.trim();
      if(!name || !mobile) { alert('‡§®‡§æ‡§µ ‡§µ ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§¶‡•ç‡§Ø‡§æ'); return; }
      push(ref(db,'suppliers'),{name,mobile,village})
        .then(()=> {
          alert('‡§™‡•Å‡§∞‡§µ‡§†‡§æ‡§¶‡§æ‡§∞ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡§æ ‚úÖ');
          document.getElementById('s_name').value='';
          document.getElementById('s_mobile').value='';
          document.getElementById('s_village').value='';
        })
        .catch(e=>{console.error(e);alert('‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä')});
    }

    // listen collections and update table + today total + cans
    onValue(ref(db,'milkCollection'), snapshot => {
      const data = snapshot.val() || {};
      const tbody = document.getElementById('collectionBody');
      tbody.innerHTML = '';
      // today string in YYYY-MM-DD
      const todayStr = new Date().toISOString().slice(0,10);
      let todayTotal = 0;

      // keep rows sorted by date desc (optional)
      const keys = Object.keys(data).sort((a,b)=>{
        const da = data[a].date || '', dbv = data[b].date || '';
        return dbv.localeCompare(da);
      });

      for(const k of keys){
        const r = data[k];
        const liters = parseFloat(r.liters || 0);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.memberNo||''}</td>
                        <td>${r.name||''}</td>
                        <td>${r.date||''}</td>
                        <td>${r.type||''}</td>
                        <td>${liters}</td>
                        <td>${r.fat||''}</td>
                        <td>${r.rate||''}</td>
                        <td>${r.amount||''}</td>`;
        tbody.appendChild(tr);

        if(r.date === todayStr){
          todayTotal += liters;
        }
      }

      // update today total UI
      document.getElementById('todayTotal').innerText = Number(todayTotal.toFixed(2));

      // update cans visualization
      renderCans(todayTotal);
    });

    // suppliers listen
    onValue(ref(db,'suppliers'), snap => {
      const data = snap.val() || {};
      const tb = document.getElementById('suppliersBody');
      tb.innerHTML = '';
      for(const k of Object.keys(data)){
        const r = data[k];
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.name||''}</td><td>${r.mobile||''}</td><td>${r.village||''}</td>`;
        tb.appendChild(tr);
      }
    });

    // ---- cans rendering ----
    const cansRow = document.getElementById('cansRow');
    function renderCans(totalLiters){
      cansRow.innerHTML = '';
      const maxCans = 10; // visual limit
      const neededCans = Math.min(maxCans, Math.ceil(totalLiters / perCan));
      // if no milk, show 1 empty can
      const count = Math.max(1, neededCans);
      let remaining = totalLiters;
      for(let i=0;i<count;i++){
        const lit = Math.min(perCan, Math.max(0, remaining));
        const fillPercent = (lit / perCan) * 100;
        remaining -= lit;

        const canWrap = document.createElement('div');
        canWrap.style.textAlign='center';
        canWrap.innerHTML = `
          <div class="can" role="img" aria-label="milk can">
            <div class="cap"></div>
            <div class="milk-fill" style="height:${fillPercent}%;"><span style="opacity:0.9;font-size:11px">${Math.round(fillPercent)}%</span></div>
          </div>
          <div class="can-label">${Math.round(lit)}L</div>
        `;
        cansRow.appendChild(canWrap);
      }

      // if total exceeds visual capacity, add summary badge
      if(totalLiters > perCan * maxCans){
        const more = document.createElement('div');
        more.style.padding='8px';
        more.style.fontSize='0.9rem';
        more.style.color='#444';
        more.innerText = `‡§Ü‡§£‡§ø ${Math.round(totalLiters - perCan*maxCans)}L ‡§Ö‡§ß‡§ø‡§ï`;
        cansRow.appendChild(more);
      }
    }
    // init empty
    renderCans(0);

    // ---- PDF / Excel ----
    window.downloadPDF = function(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text('‡§¶‡•Ç‡§ß ‡§∏‡§Ç‡§ï‡§≤‡§® ‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§°', 14, 15);
      doc.autoTable({ html: '#collectionTable', startY: 25, headStyles:{fillColor:[13,110,253]}, styles:{fontSize:10} });
      doc.save('‡§¶‡•Ç‡§ß-‡§∏‡§Ç‡§ï‡§≤‡§®.pdf');
    }

    window.downloadExcel = function(){
      try {
        const table = document.getElementById('collectionTable');
        const wb = XLSX.utils.table_to_book(table, {sheet:"‡§¶‡•Ç‡§ß ‡§∏‡§Ç‡§ï‡§≤‡§®"});
        XLSX.writeFile(wb, '‡§¶‡•Ç‡§ß-‡§∏‡§Ç‡§ï‡§≤‡§®.xlsx');
      } catch(e){ console.error(e); alert('Excel export failed'); }
    }

    // expose renderCans for debugging (optional)
    window.renderCans = renderCans;

  </script>
</body>
</html>
